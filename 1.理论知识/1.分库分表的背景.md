### 什么是分库分表？
其实就是字面意思，很好理解：
1. 分库：从单个数据库拆分成多个数据库的过程，将数据散落在多个数据库中
2. 分表：从单个表拆分成多个表的过程，将数据散落在多个表中

### 为什么要分库分表
**关键字：提升性能、增加可用性**
#### 从性能上看
随着单库中的数据量越来越大、数据库的查询QPS越来越高，相应的，对数据库的读写所需要的时间也越来越多。数据库的读写性能可能会成为业务发展的瓶颈，在进行基础的数据量大单机复制SQL计算的时候，SQL语句执行占用CPU的使用率就会变高，不单只这种原因，也有扫描行数大、锁冲突、锁等待等等原因。对应的，就需要做数据库性能方面的优化。

==如果数据库的查询QPS过高，就需要考虑拆库，通过分库来分担单个数据库的链接压力。==比如，如果查询QPS为3500，假设单库可以支撑1000个连接数的话，那么就可以考虑拆分成4个库，来分散查询连接压力。这样每个库理论上只需要负载875个连接数。

如果单表数据量过大，当数据量超过一定量级后，无论是对于数据查询还是数据更新，在经过索引优化等纯数据库层面的传统优化手段之后，还是可能存在性能问题。这是量变产生了质变，这时候就需要去换个思路来解决问题，==比如：从数据生产源头、数据处理源头来解决问题，既然数据量很大，我们就来个分而治之，化整为零。这就产生了分表，把数据按照一定的规则拆分成多张表，来解决单表环境下无法解决的存取性能问题。==

#### 从可用性上看
单个数据库如果发生意外，很可能会丢失所有数据。尤其是云时代，很多数据库都跑在虚拟机上，如果虚拟机/宿主机发生意外，则可能造成无法挽回的损失。==因此，除了传统的 Master-Slave、Master-Master等部署层面解决可靠性问题外，我们也可以考虑从数据拆分层面解决此问题。==

当连接数过多时，就会出现‘too many connections’的错误，这种访问量太大或者是数据库设置的最大连接数太小的原因。mysql的默认的最大连接数是100，可以进行修改，而mysql服务允许最大的连接数为16384。数据库分表可以解决单表海量数据的查询性能问题，数据库分库可以解决单台数据库的并发访问压力问题。

### 什么时候考虑使用分库分表呢？

==能不使用分库分表就尽量不使用分库分表，并不是所有的表都需要进行切分的，主要还是看数据的增长速度。切分后是对在某一些程度是提高了业务的复杂程度，数据库除了承载数据的存储和查询以外，能更好的协助业务实现需求也是重要的工作。==

不到万不得已不要轻易使用分库分表，避免==过度设计==和==过早优化==。==在进行分库分表之前，不要是因为想分而分，更是要先去做力所能及的事情，比如说：给硬件升级、给网络升级、读写分离等等。数据量达到单表的瓶颈时在考虑使用分库分表。==

数据量过大会影响业务的正常访问，对数据库的备份如果是单表很大的话，备份的时候就需要大量的磁盘IO和网络IO。对一个很大的表进行DDL修改的时候，Mysql会锁住全表，这个时间会挺长，这个时间段里业务是不能访问这个表的，造成的影响会很大。因为数据量大的表会经常访问与更新，这种情况就会有可能出现锁的等待。这时候将数据进行切分，用空间换时间，降低访问压力。

安全性和可用性，在业务的层面进行垂直切分的话，将不相关的数据库来进行分隔，因为的话每个业务的数据量，访问量都不一样，不能因为一个业务就把数据库搞挂掉牵连到其他的业务。利用水平切分的话，当一个数据库出现了问题，不会影响到全部的用户，因为每个库只承担了业务的一小部分数据，这样的整体可用性就可以得到提高。

### 如何分库分表
#### 分库分表方案可以分为以下3种：

![[Pasted image 20221214180041.png]]

#### 如何选择我们自己的切分方案
#### 如果需要分表，那么分多少张表合适？
==阿里巴巴开发手册建议是：==
> 【推荐】单表行数超过500万行或者单表容量超过2GB，才推荐进行[分库分表](https://so.csdn.net/so/search?q=%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8&spm=1001.2101.3001.7020)。  
> 说明：如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。

==由于所有的技术都是为业务服务的，那么，我们就先从数据方面回顾下业务背景。==
【问题单】表每日产生数据约8W
【操作日志】表每日产生数据80W（每条问题单产生10条操作日志）
假设系统估计使用年限为5年，那么问题单数据量大约=5年 365天/年 8w/天 = 1.46亿，
那么估算出的表数量如下：
1. 【问题单】需要：1.46亿/500w = 29.2张表， 我们就按32张表来切分；
2. 【操作日志】需要：32 * 10 = 320张表

#### 如果需要分库，那么分多少库合适？

分库的时候除了要考虑平时的业务峰值读写QPS外，还需要考虑到诸如双11大促期间可能达到的==峰值==，需要提前做好预估。

根据我们的实际业务场景，可以根据历史QPS、RT等数据评估计算出分库数量：
总连接数 / 单库可承担最高连接数  = 分库数量

#### 如何对数据进行切分？

根据行业管理，通常按照==水平切分、垂直切分==两种方式进行切分，当然有些复杂业务场景也可能选择两者结合的方式。

#### #垂直分表
==定义：垂直分表也就是把“大表拆成小表”，基于列字段进行的。拆分的原则一般是表中的字段较多，将不常用的或者是数据较大，长度较长的拆分到扩展表里，如text类类型字段。把访问频次低、字段大的商品描述信息单独的放在一张表里，访问频次较为多的商品基本信息单独的放在一张表里。==

垂直拆分的原则：把不常用的字段单独的放在一张表里，把大字段拆分出来放在附表中，把业务经常组合查询的列放在一张表中。

#### 为什么大字段的IO效率低下呢？

第一点就是由于数据量本身的庞大的，需要更长的读取时间；第二点就是跨页，也是数据库的存储单位，很多操作包括查找这些都是以页为单位的，单页里的数据行越多的话数据库的整体性能就越好，并且的话字段大所占用的空间也大，单页内的存储行数少，所以IO效率就较为低下；第三就是数据库以行为单位把数据加载到内存当中，这样的话表里的字段长度较为短并访问的频率高，内存就能加载到了更多的数据，命中率就更高了，减少了磁盘的IO，提升了数据库的性能。

#### #垂直分库
垂直分库是针对的是一个系统中不同业务进行拆分的，数据库的连接资源比较宝贵并且单机的处理能力也是有限的。在没拆分之前全部都是落到单一的库上的，这时候单库的处理能力有瓶颈，与之还有的是磁盘的空间、内存、tps等限制。拆分之后，避免不同库竞争同一个物理机上的CPU、内存/网络IO、磁盘，所以在高并发的场景下，垂直分库一定程度上能够突破IO、连接数及单机硬件资源的瓶颈。垂直分库可以更好的解决业务层面的耦合，业务清晰并且方便管理和维护。==一般从单体项目升级改造成为微服务项目的话，那就是垂直分库。==

#### #水平分表
水平分表都是大表拆小表，垂直分表是按表结构进行拆分，水平分表是按数据结构进行拆分。==把一个表的数据分到一个数据库的多张表里，每个表只有这个表的部分数据，其核心就是把一个大表分割成多个小表，每一个的结构是一样的，数据不一样，全部表的数据合起来就是全部的数据，针对数据量巨大的单张表（比如订单表）照某种规则（RANGE,HASH取模等），切分到多张表里面去。==但是这些表还是在同一个库中，所以单数据库操作还是有IO瓶颈，主要是解决单表数据量过大的问题。减少锁表时间，没分表前，如果是DDL(create/alter/add等)语句，当需要添加一列的时候mysql会锁表，期间所有的读写操作只能等待。
![[Pasted image 20221215101551.png]]

#### #水平分库
==把同个表的数据按照一定的规则分到不同的数据库里，数据库在不同的服务器上，水平分库就是把不同的表拆分到不同的数据库里，它是对数据的行拆分，不会影响表的结构。==每个库的结构都一样，但是每个库的数据都不一样，没有交集，库的并集就是全量数据了。但水平分库的粒度会比水平分表更大。
![[Pasted image 20221215101711.png]]

#### 分库分表总结：
垂直角度（表结构不一样）
垂直分表:==将一个表字段拆分成多个表，每个表存储部分字段。好处是避免IO时锁表的次数，分离热点字段和非热点字段，避免大字段IO导致性能下降。原则是业务经常组合查询的字段一个表；不常用字段一个表；text、blob类型字段作为附属表==

垂直分库：==根据业务将表分类放到不同的数据库服务器上，好处是避免表之间竞争同个物理机的资源，比如CPU/内存/硬盘/网络IO，原则是根据业务相关性进行划分，领域模型，微服务划分一般就是垂直分库。==

水平角度（表结构一样）
水平分库：==把同个表的数据按照一定规则分到不同的数据库中，数据库在不同的服务器上。好处:是多个数据库，降低了系统的IO和CPU压力。原则是选择合适的分片键和分片策略，和业务场景配合；避免数据热点和访问不均衡、避免二次扩容难度大==

水平分表：==同个数据库内，把一个表的数据按照一定规则拆分到多个表中，对数据进行拆分，不影响表结构。好处是单个表的数据量少了，业务SQL执行效率高，降低了系统的IO和CPU压力。原则是选择合适的分片键和分片策略，和业务场景配合；避免数据热点和访问不均衡、避免二次扩容难度大。==
